name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.2.app

      - name: Build
        run: |
          xcodebuild \
            -project "Directory Printer/Directory Printer.xcodeproj" \
            -scheme "Directory Printer" \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -derivedDataPath build \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            MACOSX_DEPLOYMENT_TARGET=13.0 \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES

      - name: Package
        run: |
          cd build/Build/Products/Release
          ditto -c -k --keepParent "Directory Printer.app" "Directory-Printer-${{ github.ref_name }}.zip"

      - name: Extract release notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          NOTES=$(awk "/^### ${VERSION}$/{found=1; next} found && /^### /{exit} found{print}" README.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Directory Printer ${{ github.ref_name }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ---

            ## Installation

            The app isn't notarized by Apple so Gatekeeper will block it on first launch. To open it:

            **Option 1: System Settings (recommended)**
            1. Try to open the app — macOS will show a warning
            2. Open **System Settings → Privacy & Security**
            3. Scroll down to the **Security** section
            4. Click **"Open Anyway"** next to the Directory Printer warning
            5. Confirm by clicking **"Open"** in the dialog

            **Option 2: Terminal**
            ```bash
            xattr -cr /Applications/Directory\ Printer.app
            ```

            You only need to do this once. After that, the app will open normally.

            Each release is built from the source code shown on GitHub, feel free to look through the code for safety before installation.
          files: build/Build/Products/Release/Directory-Printer-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
